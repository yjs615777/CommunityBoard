@using CommunityBoard.Contracts.Response
@using CommunityBoard.Contracts.Common
@model PagedResult<PostListItemDto>

@{
    ViewData["Title"] = "자유게시판";
    ViewData["LayoutTheme"] = "default-theme";
    Layout = "_Layout";

    int totalPages = (int)Math.Ceiling(Model.Total / (double)Model.Size);
    int page = Model.Page;  
    int size = Model.Size;
    int startNumber = Model.Total - ((page - 1) * size);
}

@section Head {
    <link rel="stylesheet" href="~/css/pages/posts-index.css" />
}

<section class="board-stage">
    <h1 class="board-title">자유게시판</h1>

    <div class="table-wrap">
        <table class="board-table">
            <colgroup>
                <col class="col-no" />
                <col class="col-title" />
                <col class="col-author" />
                <col class="col-date" />
                <col class="col-views" />
            </colgroup>
            <thead>
                <tr>
                    <th>번호</th>
                    <th>제목</th>
                    <th>작성자</th>
                    <th>작성일</th>
                    <th>조회수</th>
                </tr>
            </thead>
            <tbody>
                @for (var i = 0; i < Model.Items.Count; i++)
                {
                    var p = Model.Items[i];
                    var local = p.CreatedAt.ToLocalTime();
                    string dateText = (local.Date == DateTime.Today)
                    ? local.ToString("HH\\:mm")
                    : local.ToString("M\\.d");

                    string rowClass = p.IsPinned ? "row pinned" : "row";
                    <tr class="@rowClass">
                        <td class="cell-no">@((startNumber - i) > 0 ? (startNumber - i) : 0)</td>
                        <td class="cell-title">
                            @if (p.IsPinned)
                            {
                                <span class="badge-pin">고정</span>
                            }
                            <a asp-controller="Posts" asp-action="Detail" asp-route-id="@p.Id" class="link">@p.Title</a>
                        </td>
                        <td>@p.AuthorName</td>
                        <td>@dateText</td>
                        <td class="num">@p.ViewCount</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <nav class="pagination">
        @if (page > 1)
        {
            <a class="page" href="/Posts?page=@(page - 1)&pageSize=@size">이전</a>
        }

        @{
            int win = 3;
            int from = Math.Max(1, page - win);
            int to = Math.Min(totalPages, page + win);

            if (from > 1)
            {
                <a class="page" href="/Posts?page=1&pageSize=@size">1</a>
                if (from > 2)
                {

                    <span class="dots">…</span>
                }
            }
            for (int i = from; i <= to; i++)
            {
                if (i == page)
                {

                    <span class="page current">@i</span>
                }
                else
                {

                    <a class="page" href="/Posts?page=@i&pageSize=@size">@i</a>
                }
            }
            if (to < totalPages)
            {
                if (to < totalPages - 1)
                {

                    <span class="dots">…</span>
                }
                <a class="page" href="/Posts?page=@totalPages&pageSize=@size">@totalPages</a>
            }
        }

        @if (page < totalPages)
        {
            <a class="page" href="/Posts?page=@(page + 1)&pageSize=@size">다음</a>
        }

        @if (User.Identity?.IsAuthenticated ?? false)
        {
            <a class="btn write" asp-controller="Posts" asp-action="Create">글쓰기</a>
        }
    </nav>
</section>
